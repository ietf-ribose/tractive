#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../lib/tractive"

class TractiveCommand < Thor
  default_command :default
  class_option "attachmentexporter", type: :string, aliases: ["-A", "--attachment-exporter"],
                                     desc: "Generate an attachment exporter script according to config.yaml"
  class_option "attachurl", type: :string, aliases: ["-a", "--attachment-url"], banner: "<URL>",
                            desc: "If attachment files are reachable via a URL we reference this here"
  class_option "config", type: :string, default: "trac-hub.config.yaml", banner: "<PATH>", aliases: "-c",
                         desc: "Set the configuration file"
  class_option "dryrun", type: :boolean, aliases: ["-d", "--dry-run"],
                         desc: "Write data to a file instead of pushing it to github"
  class_option "exportattachments", type: :string, aliases: ["-e", "--export-attachments"],
                                    desc: "Export attachments from the databse according to config.yaml"
  class_option "fast", type: :boolean, aliases: ["-F", "--fast-import"],
                       desc: "Import without safety-checking issue numbers."
  class_option "info", type: :boolean, aliases: ["-i", "--info"],
                       desc: "Reports existing labels and users in the database"
  class_option "mockdeleted", type: :boolean, aliases: ["-M", "--mockup"],
                              desc: "Import from 0 and mocking tickets deleted on trac"
  class_option "openedonly", type: :boolean, aliases: ["-o", "--opened-only"],
                             desc: "Skips the import of closed tickets"
  class_option "revmapfile", type: :string, aliases: ["-r", "--rev-map-file"], banner: "<PATH>",
                             desc: "Allows to specify a commit revision mapping FILE"
  class_option "singlepost", type: :boolean, aliases: ["-S", "--single-post"],
                             desc: "Put all issue comments in the first message."
  class_option "start", type: :numeric, aliases: ["-s", "--start-at"], banner: "<ID>",
                        desc: "Start migration from ticket with number <ID>"
  class_option "verbose", type: :boolean, aliases: ["-v", "--verbose"], desc: "Verbose mode"

  def self.exit_on_failure?
    true
  end

  desc "<OPTIONS>", "Migrate Trac instances to modern Git management platforms like GitHub and GitLab"
  def default
    verify_config_options!
    Tractive::Main.new(options).run
  end

  def method_missing(*args)
    warn "No method found named: #{args[0]}"
    warn "Run with `--help` or `-h` to see available options"
    exit 1
  end

  def respond_to_missing?
    true
  end

  no_commands do
    def verify_config_options!
      return if File.exist?(options[:config])

      raise "missing configuration file (#{configfiles})"
    end
  end
end

TractiveCommand.start(ARGV)
